<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>UnionPay Chat</title>
    <link rel="stylesheet" href="index.css">
    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript" src="/socket.io/socket.io.js"></script>
</head>

<body>
    <div class="main">
        <div class="logo">
            <img src="logo.png" alt="logo">
        </div>
        <div class="from">
            <textarea id="chat" readonly></textarea>
        </div>
        <div class="to">
            <input id="msg" tabindex="1" placeholder="Press the Enter to send message." onkeydown="keydown()" />
        </div>
        <div class="tip">
            <p>演示</p>
        </div>
    </div>
    <script type="text/javascript">
    function keydown() {
        if (event.keyCode == 13 && $('#msg').val().trim().length > 0) {
            send();
        }
    }

    var msgs = [];

    setInterval(function() {
        var m = msgs.shift();
        if (m) {
            $("#chat").scrollTop($("#chat")[0].scrollHeight);
            $('#chat').val($('#chat').val() + m);
        }
    }, 24);

    var socket = io();

    function setname(name) {
        socket.emit('setname', name);
    }

    socket.on('message', function(msg) {
        console.log('message:' + msg);
    });

    socket.on('disconnect', function() {
        console.log('have been disconnected.');
    });

    socket.on('reconnect', function() {
        console.log('have been reconnected.');
        setname('<%=p%>');
    });
    // 4交易结束
    socket.on('transfer end', function(msg) {
        (msg + '\n').split('').map(function(a) { msgs.push(a); });
        console.log('transfer end.');
    });

    function send() {
        socket.emit('message', $('#msg').val().trim());
        $('#msg').val('');
    }

    $(function() {
        $('#msg')[0].focus();
        $('body').click(function() {
            $('#msg')[0].focus();
        });
        setname('<%=p%>');
    });
    </script>
</body>

</html>