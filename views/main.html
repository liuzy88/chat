<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title><%=p%></title>
    <link rel="stylesheet" href="index.css">
    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript" src="/socket.io/socket.io.js"></script>
</head>

<body>
    <div class="main">
        <div class="logo">
            <img src="logo.png" alt="logo">
        </div>
        <div class="from">
            <textarea id="chat" readonly></textarea>
        </div>
        <!-- <div class="to">
            <input id="msg" tabindex="1" placeholder="Press the Enter to send message." onkeydown="keydown()" />
        </div> -->
        <div class="tip">
            <p>*演示项目*</p>
        </div>
    </div>
    <script type="text/javascript">
    function keydown() {
        if (event.keyCode == 13 && $('#msg').val().trim().length > 0) {
            send();
        }
    }

    var msgs = [];

    setInterval(function() {
        var m = msgs.shift();
        if (m) {
            $("#chat").scrollTop($("#chat")[0].scrollHeight);
            $('#chat').val($('#chat').val() + m);
        }
    }, 20);

    var socket = io();

    function setname(name) {
        socket.emit('setname', name);
    }

    function showmsg(msg) {
        (msg + '\n').split('').map(function(a) { msgs.push(a); });
    }

    socket.on('message', function(msg) {
        console.log(msg);
        showmsg(msg);
    });

    socket.on('disconnect', function() {
        console.log('have been disconnected.');
        showmsg('have been disconnected.');
    });

    socket.on('reconnect', function() {
        console.log('have been reconnected.');
        showmsg('have been reconnected.');
        setname('<%=p%>');
    });
    // 1交易开始
    socket.on('transfer start', function(msg) {
        showmsg(msg);
        socket.emit('validate start', 'validate is start.');
    });
    // 2验证开始
    socket.on('validate start', function(msg) {
        showmsg(msg);
        socket.emit('validate end', 'validate is end.');
    });
    // 3验证结束
    socket.on('validate end', function(msg) {
        showmsg(msg);
        socket.emit('transfer end', 'transfer is end.');
    });
    // 4交易结束
    socket.on('transfer end', function(msg) {
        showmsg(msg);
        console.log('transfer end.');
    });

    function send() {
        socket.emit('message', $('#msg').val().trim());
        $('#msg').val('');
    }

    $(function() {
        // $('#msg')[0].focus();
        // $('body').click(function() {
        //     $('#msg')[0].focus();
        // });
        setname('<%=p%>');
    });
    </script>
</body>

</html>